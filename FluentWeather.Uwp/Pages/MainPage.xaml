<Page
    x:Class="FluentWeather.Uwp.Pages.MainPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:app="using:FluentWeather.Uwp.Shared"
    xmlns:behaviors="using:FluentWeather.Uwp.Behaviors"
    xmlns:controls="using:Microsoft.Toolkit.Uwp.UI.Controls"
    xmlns:controls1="using:FluentWeather.Uwp.Controls"
    xmlns:converters="using:ValueConverters"
    xmlns:core="using:Microsoft.Xaml.Interactions.Core"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:dialogs="using:FluentWeather.Uwp.Controls.Dialogs"
    xmlns:i="using:Microsoft.Xaml.Interactivity"
    xmlns:interfaces="using:FluentWeather.Abstraction.Interfaces.Weather"
    xmlns:interop="using:Windows.UI.Xaml.Interop"
    xmlns:local="using:FluentWeather.Uwp.Pages"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:media="using:Microsoft.Toolkit.Uwp.UI.Media"
    xmlns:models="using:FluentWeather.Abstraction.Models"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    xmlns:toolkit="using:Microsoft.Toolkit.Uwp.UI.Controls"
    xmlns:viewmodels="using:FluentWeather.Uwp.ViewModels"
    d:RequestedTheme="Dark"
    mc:Ignorable="d">
    <Page.Resources>
        <converters:ValueConverterGroup x:Key="BoolNegationToVisibilityConverter">
            <converters:BoolNegationConverter />
            <converters:BoolToVisibilityConverter />
        </converters:ValueConverterGroup>
    </Page.Resources>
    <Grid>
        <Border Background="#40404040" Canvas.ZIndex="2" Visibility="{x:Bind ViewModel.IsLoading,Mode=OneWay}">
            <muxc:ProgressRing Height="100" Width="100"/>
        </Border>

        <ScrollViewer
            x:Name="MainScrollViewer"
            x:FieldModifier="Public"
            Canvas.ZIndex="1"
            VerticalScrollBarVisibility="Auto">
            <Grid
                x:Name="ContentGrid"
                MaxWidth="1024"
                Margin="32,40,32,32">
                <Grid.ChildrenTransitions>
                    <TransitionCollection>
                        <EntranceThemeTransition FromVerticalOffset="50" IsStaggeringEnabled="True" />
                        <RepositionThemeTransition IsStaggeringEnabled="False" />
                    </TransitionCollection>
                </Grid.ChildrenTransitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!--  当前天气  -->
                <Grid Margin="0,0,0,12" x:DefaultBindMode="OneWay">
                    <StackPanel>
                        <StackPanel Opacity="0.95" Orientation="Horizontal">
                            <TextBlock
                                x:Name="TemperatureText"
                                Style="{ThemeResource TemperatureTextStyle}"
                                Text="{Binding WeatherNow.Temperature}" />
                            <Grid Margin="4,26,0,0">
                                <TextBlock
                                    Margin="2,-16,0,0"
                                    Style="{ThemeResource TemperatureUnitTextStyle}"
                                    Text="°" />
                                <TextBlock
                                    VerticalAlignment="Bottom"
                                    Style="{StaticResource WeatherNowDescriptionTextStyle}"
                                    Text="{x:Bind ViewModel.WeatherNow.Description}" />
                            </Grid>
                        </StackPanel>
                        <StackPanel Margin="0,-8,0,0" Orientation="Horizontal">
                            <TextBlock
                                VerticalAlignment="Center"
                                FontSize="18"
                                Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}">
                                <Run Text="体感" />
                                <Run Text="{Binding WeatherNow.ApparentTemperature}" /><Run Text="°" />
                            </TextBlock>
                            <Button
                                Margin="12,0,0,0"
                                Background="Transparent"
                                BorderBrush="Transparent"
                                Visibility="{x:Bind ViewModel.AirCondition.AqiCategory, Converter={StaticResource NullToVisibilityConverter}}">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock FontSize="17" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}">
                                        <Run Text="空气质量 -" />
                                        <Run Text="{x:Bind ViewModel.AirCondition.AqiCategory}" />
                                    </TextBlock>
                                    <FontIcon
                                        FontSize="14"
                                        Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                                        Glyph="&#xE00F;" />
                                </StackPanel>
                                <Button.Resources>
                                    <ResourceDictionary>
                                        <SolidColorBrush x:Key="ButtonBackgroundDisabled" Color="#0000" />
                                        <SolidColorBrush x:Key="ButtonBorderBrushDisabled" Color="#0000" />
                                    </ResourceDictionary>
                                </Button.Resources>
                                <i:Interaction.Behaviors>
                                    <behaviors:ButtonContentSnapBehavior SnapType="Left" />
                                </i:Interaction.Behaviors>
                                <Button.Flyout>
                                    <Flyout Placement="BottomEdgeAlignedLeft">
                                        <Grid>
                                            <HyperlinkButton
                                                HorizontalAlignment="Right"
                                                VerticalAlignment="Top"
                                                Canvas.ZIndex="1"
                                                NavigateUri="{Binding AirCondition.Link}"
                                                ToolTipService.ToolTip="查看详细信息">
                                                <FontIcon FontSize="16" Glyph="&#xE2B4;" />
                                            </HyperlinkButton>
                                            <StackPanel Spacing="8">
                                                <TextBlock>
                                                    <Run
                                                        FontSize="34"
                                                        FontWeight="SemiBold"
                                                        Text="{x:Bind ViewModel.AirCondition.Aqi}" />
                                                    <Run FontSize="16" Text="{x:Bind ViewModel.AirCondition.AqiCategory}" />
                                                </TextBlock>
                                                <StackPanel
                                                    Margin="0,0,8,0"
                                                    Orientation="Horizontal"
                                                    Spacing="20">
                                                    <StackPanel>
                                                        <TextBlock
                                                            HorizontalAlignment="Center"
                                                            FontSize="26"
                                                            Text="{Binding AirCondition.PM25}" />
                                                        <TextBlock
                                                            HorizontalAlignment="Center"
                                                            Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                                                            Text="PM2.5" />
                                                    </StackPanel>
                                                    <StackPanel>
                                                        <TextBlock
                                                            HorizontalAlignment="Center"
                                                            FontSize="26"
                                                            Text="{Binding AirCondition.PM10}" />
                                                        <TextBlock
                                                            HorizontalAlignment="Center"
                                                            Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                                                            Text="PM10" />
                                                    </StackPanel>
                                                    <StackPanel>
                                                        <TextBlock
                                                            Margin="0,0,4,0"
                                                            HorizontalAlignment="Center"
                                                            FontSize="26"
                                                            Text="{Binding AirCondition.SO2}" />
                                                        <TextBlock
                                                            HorizontalAlignment="Center"
                                                            Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                                                            Text="SO₂" />
                                                    </StackPanel>
                                                    <StackPanel>
                                                        <TextBlock
                                                            Margin="0,0,4,0"
                                                            HorizontalAlignment="Center"
                                                            FontSize="26"
                                                            Text="{Binding AirCondition.NO2}" />
                                                        <TextBlock
                                                            HorizontalAlignment="Center"
                                                            Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                                                            Text="NO₂" />
                                                    </StackPanel>
                                                    <StackPanel>
                                                        <TextBlock
                                                            Margin="0,0,4,0"
                                                            HorizontalAlignment="Center"
                                                            FontSize="26"
                                                            Text="{Binding AirCondition.O3}" />
                                                        <TextBlock
                                                            HorizontalAlignment="Center"
                                                            Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                                                            Text="O₃" />
                                                    </StackPanel>
                                                    <StackPanel>
                                                        <TextBlock
                                                            HorizontalAlignment="Center"
                                                            FontSize="26"
                                                            Text="{Binding AirCondition.CO}" />
                                                        <TextBlock
                                                            HorizontalAlignment="Center"
                                                            Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                                                            Text="CO" />
                                                    </StackPanel>
                                                </StackPanel>
                                                <TextBlock
                                                    Margin="0,0,4,0"
                                                    HorizontalAlignment="Right"
                                                    Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                                                    Text="单位:μg/m³" />

                                            </StackPanel>
                                        </Grid>
                                    </Flyout>
                                </Button.Flyout>
                            </Button>
                        </StackPanel>
                        <Border Visibility="{x:Bind ViewModel.Precipitation.Precipitations, Converter={StaticResource NullToVisibilityConverter}}">
                            <TextBlock
                                FontSize="17"
                                Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                                Text="{Binding Precipitation.Summary}"
                                Visibility="{x:Bind PrecipGrid.Visibility, Converter={StaticResource VisibilityInverter}}" />
                        </Border>
                    </StackPanel>
                </Grid>

                <!--  降水概率  -->
                <Grid
                    x:Name="PrecipGrid"
                    Grid.Row="1"
                    Visibility="{x:Bind GetPrecipChartVisibility(ViewModel.Precipitation), Mode=OneWay}">
                    <muxc:Expander HorizontalAlignment="Stretch" Header="{Binding Precipitation.Summary}">
                        <controls1:PrecipitationChart Height="200" Precipitations="{x:Bind ViewModel.Precipitation.Precipitations, Mode=OneWay}" />
                    </muxc:Expander>
                </Grid>

                <!--  预警  -->
                <Grid Grid.Row="2" Margin="-12,4,-12,0">
                    <ListView
                        HorizontalContentAlignment="Stretch"
                        ItemsSource="{x:Bind ViewModel.Warnings, Mode=OneWay}"
                        SelectionMode="None">
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="models:WeatherWarningBase">
                                <controls1:WarningItem Margin="0,4" Warning="{x:Bind Mode=OneWay}" />
                            </DataTemplate>
                        </ListView.ItemTemplate>
                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="Transitions">
                                    <Setter.Value>
                                        <TransitionCollection>
                                            <RepositionThemeTransition IsStaggeringEnabled="False" />
                                        </TransitionCollection>
                                    </Setter.Value>
                                </Setter>
                                <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            </Style>
                        </ListView.ItemContainerStyle>
                    </ListView>

                </Grid>

                <!--  7天天气预报  -->
                <Grid Grid.Row="3" Margin="0,0,0,0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <toolkit:AdaptiveGridView
                        x:Name="DailyGridView"
                        Margin="0,0,0,0"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Stretch"
                        DesiredWidth="120"
                        IsItemClickEnabled="True"
                        ItemHeight="165"
                        ItemsSource="{x:Bind ViewModel.DailyForecasts7D, Mode=OneWay}"
                        OneRowModeEnabled="True"
                        ItemTemplate="{StaticResource WeatherForecastTemplate}"
                        SelectionMode="None">
                        <i:Interaction.Behaviors>
                            <behaviors:ListViewScrollBehavior />
                            <behaviors:ListViewOpenContentDialogBehavior DialogType="dialogs:DailyForecastDialog" UseArguments="True" />
                        </i:Interaction.Behaviors>
                    </toolkit:AdaptiveGridView>
                    <Button
                        Grid.Row="0"
                        Width="40"
                        Height="40"
                        Margin="-20,0,0,0"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Center"
                        HorizontalContentAlignment="Stretch"
                        Background="Transparent"
                        BorderBrush="Transparent"
                        CornerRadius="50">
                        <FontIcon Margin="-3,0,0,0" Glyph="&#xE00E;" />
                        <i:Interaction.Behaviors>
                            <behaviors:ListViewScrollButtonBehavior IsRight="False" ListView="{x:Bind DailyGridView}" />
                        </i:Interaction.Behaviors>
                        <Button.Resources>
                            <ResourceDictionary>
                                <SolidColorBrush x:Key="ButtonBackgroundDisabled" Color="#0000" />
                                <SolidColorBrush x:Key="ButtonBorderBrushDisabled" Color="#0000" />
                            </ResourceDictionary>
                        </Button.Resources>
                    </Button>
                    <Button
                        Grid.Row="0"
                        Width="40"
                        Height="40"
                        Margin="0,0,-20,0"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Center"
                        Background="Transparent"
                        BorderBrush="Transparent"
                        CornerRadius="50">
                        <FontIcon Margin="-1,0,0,0" Glyph="&#xE00F;" />
                        <i:Interaction.Behaviors>
                            <behaviors:ListViewScrollButtonBehavior ListView="{x:Bind DailyGridView}" />
                        </i:Interaction.Behaviors>
                        <Button.Resources>
                            <ResourceDictionary>
                                <SolidColorBrush x:Key="ButtonBackgroundDisabled" Color="#0000" />
                                <SolidColorBrush x:Key="ButtonBorderBrushDisabled" Color="#0000" />
                            </ResourceDictionary>
                        </Button.Resources>
                    </Button>
                    <controls1:TemperatureChart
                        x:Name="TemperatureChart"
                        Grid.Row="1"
                        Height="200"
                        Margin="-32,0,-28,0"
                        Visibility="Collapsed"
                        WeatherForecasts="{Binding DailyForecasts7D}" />
                </Grid>
                <!--  每小时预报  -->
                <Grid Grid.Row="4" Margin="0,12,0,0">
                    <toolkit:AdaptiveGridView
                        x:Name="HourlyGridView"
                        Margin="0,16,0,0"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Stretch"
                        DesiredWidth="100"
                        IsItemClickEnabled="True"
                        ItemHeight="128"
                        ItemsSource="{x:Bind ViewModel.HourlyForecasts24H, Mode=OneWay}"
                        OneRowModeEnabled="True"
                        ItemTemplate="{StaticResource WeatherHourlyForecastTemplate}"
                        SelectionMode="None">
                        <i:Interaction.Behaviors>
                            <behaviors:ListViewScrollBehavior />
                            <behaviors:ListViewOpenFlyoutBehavior />
                        </i:Interaction.Behaviors>
                    </toolkit:AdaptiveGridView>
                    <Button
                        Width="40"
                        Height="40"
                        Margin="-20,0,0,0"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Center"
                        HorizontalContentAlignment="Stretch"
                        Background="Transparent"
                        BorderBrush="Transparent"
                        CornerRadius="50">
                        <FontIcon Margin="-3,0,0,0" Glyph="&#xE00E;" />
                        <i:Interaction.Behaviors>
                            <behaviors:ListViewScrollButtonBehavior IsRight="False" ListView="{x:Bind HourlyGridView}" />
                        </i:Interaction.Behaviors>
                        <Button.Resources>
                            <ResourceDictionary>
                                <SolidColorBrush x:Key="ButtonBackgroundDisabled" Color="#0000" />
                                <SolidColorBrush x:Key="ButtonBorderBrushDisabled" Color="#0000" />
                            </ResourceDictionary>
                        </Button.Resources>
                    </Button>
                    <Button
                        Width="40"
                        Height="40"
                        Margin="0,0,-20,0"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Center"
                        Background="Transparent"
                        BorderBrush="Transparent"
                        CornerRadius="50">
                        <FontIcon Margin="-1,0,0,0" Glyph="&#xE00F;" />
                        <i:Interaction.Behaviors>
                            <behaviors:ListViewScrollButtonBehavior ListView="{x:Bind HourlyGridView}" />
                        </i:Interaction.Behaviors>
                        <Button.Resources>
                            <ResourceDictionary>
                                <SolidColorBrush x:Key="ButtonBackgroundDisabled" Color="#0000" />
                                <SolidColorBrush x:Key="ButtonBorderBrushDisabled" Color="#0000" />
                            </ResourceDictionary>
                        </Button.Resources>
                    </Button>

                </Grid>

                <!--  其他信息  -->
                <Grid Grid.Row="5" Margin="0,24,0,0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <TextBlock
                        Margin="12,0,0,0"
                        FontSize="16"
                        Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}">
                        <Run
                            FontFamily="{ThemeResource SymbolThemeFontFamily}"
                            FontSize="14"
                            Text="&#xE018; " /><Run Text="日出" />
                        <Run Text="{x:Bind ViewModel.SunRise.ToShortTimeString(), Mode=OneWay}" />
                        <Run
                            FontFamily="{ThemeResource SymbolThemeFontFamily}"
                            FontSize="14"
                            Text="  &#xE099; " /><Run Text="日落" />
                        <Run Text="{x:Bind ViewModel.SunSet.ToShortTimeString(), Mode=OneWay}" />
                    </TextBlock>
                    <controls:AdaptiveGridView
                        Grid.Row="1"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Stretch"
                        x:DefaultBindMode="OneWay"
                        DesiredWidth="200"
                        ItemHeight="90"
                        SelectionMode="None">
                        <controls:AdaptiveGridView.Items>
                            <StackPanel
                                x:Name="WindInfoPanel"
                                Margin="12"
                                HorizontalAlignment="Left">
                                <TextBlock
                                    FontSize="18"
                                    Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                                    Text="风" />
                                <TextBlock FontSize="25">
                                    <Run Text="{Binding WeatherNow.WindDirection}" />
                                    <Run FontSize="25" Text="{Binding WeatherNow.WindSpeed}" />
                                    <Run FontSize="16" Text="km/h" />
                                </TextBlock>
                            </StackPanel>
                            <StackPanel Margin="12" HorizontalAlignment="Left">
                                <TextBlock
                                    FontSize="18"
                                    Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                                    Text="湿度" />
                                <TextBlock FontSize="25">
                                    <Run FontSize="25" Text="{Binding WeatherNow.Humidity}" />
                                    <Run FontSize="16" Text="%" />
                                </TextBlock>
                            </StackPanel>

                            <StackPanel Margin="12" HorizontalAlignment="Left">
                                <TextBlock
                                    FontSize="18"
                                    Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                                    Text="气压" />
                                <TextBlock FontSize="25">
                                    <Run FontSize="25" Text="{Binding WeatherNow.Pressure}" />
                                    <Run FontSize="16" Text="hPa" />
                                </TextBlock>
                            </StackPanel>
                            <StackPanel Margin="12" HorizontalAlignment="Left">
                                <TextBlock
                                    FontSize="18"
                                    Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                                    Text="能见度" />
                                <TextBlock FontSize="25">
                                    <Run FontSize="25" Text="{Binding WeatherNow.Visibility}" />
                                    <Run FontSize="16" Text="km" />
                                </TextBlock>
                            </StackPanel>
                            <StackPanel
                                Margin="12"
                                HorizontalAlignment="Left"
                                Visibility="{Binding WeatherNow.CloudAmount, Converter={StaticResource NullToVisibilityConverter}}">
                                <TextBlock
                                    FontSize="18"
                                    Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                                    Text="云量" />
                                <TextBlock FontSize="25">
                                    <Run FontSize="25" Text="{Binding WeatherNow.CloudAmount}" />
                                    <Run FontSize="16" Text="%" />
                                </TextBlock>
                            </StackPanel>
                        </controls:AdaptiveGridView.Items>
                    </controls:AdaptiveGridView>

                </Grid>
                <controls:AdaptiveGridView
                    Grid.Row="6"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Stretch"
                    x:DefaultBindMode="OneWay"
                    DesiredWidth="200"
                    IsItemClickEnabled="True"
                    ItemHeight="90"
                    ItemsSource="{x:Bind ViewModel.Indices}"
                    SelectionMode="None">
                    <controls:AdaptiveGridView.ItemTemplate>
                        <DataTemplate x:DataType="models:IndicesBase">
                            <StackPanel Margin="12" HorizontalAlignment="Stretch">
                                <TextBlock
                                    FontSize="18"
                                    Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                                    Text="{x:Bind Name}" />
                                <TextBlock FontSize="25" Text="{x:Bind Category}" />
                                <FlyoutBase.AttachedFlyout>
                                    <Flyout Placement="Top">
                                        <StackPanel MaxWidth="256" Spacing="4">
                                            <TextBlock FontSize="18" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}">
                                                <Run Text="{x:Bind Name}" />
                                                <Run Text="-" />
                                                <Run Text="{x:Bind Category}" />
                                            </TextBlock>
                                            <TextBlock
                                                FontSize="16"
                                                IsTextSelectionEnabled="True"
                                                Text="{x:Bind Description}"
                                                TextWrapping="Wrap" />
                                        </StackPanel>
                                    </Flyout>
                                </FlyoutBase.AttachedFlyout>
                            </StackPanel>
                        </DataTemplate>
                    </controls:AdaptiveGridView.ItemTemplate>
                    <i:Interaction.Behaviors>
                        <behaviors:ListViewOpenFlyoutBehavior />
                    </i:Interaction.Behaviors>
                </controls:AdaptiveGridView>
            </Grid>


        </ScrollViewer>
        <!--  内容区  -->

        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup>
                <VisualState>
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1102" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="TemperatureChart.Visibility" Value="Visible" />
                        <Setter Target="DailyGridView.Margin" Value="-32,0" />
                        <Setter Target="DailyGridView.ItemHeight" Value="150" />
                    </VisualState.Setters>
                </VisualState>
                <VisualState>
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1600" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="ContentGrid.Margin" Value="32,80,32,32" />
                        <Setter Target="TemperatureChart.Visibility" Value="Visible" />
                        <Setter Target="DailyGridView.Margin" Value="-32,0" />
                        <Setter Target="DailyGridView.ItemHeight" Value="150" />
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>
    </Grid>

</Page>
